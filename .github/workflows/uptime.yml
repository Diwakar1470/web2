name: ğŸ” Uptime Monitor

on:
  schedule:
    - cron: '*/30 * * * *'   # runs every 30 minutes
  workflow_dispatch:           # allows manual run from GitHub Actions tab

jobs:
  check-uptime:
    name: Check Site Health
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Ping health endpoint
        id: ping
        run: |
          echo "ğŸ” Checking site at $(date -u)"

          HTTP_STATUS=$(curl -o response.txt -s -w "%{http_code}" \
            --max-time 15 \
            --retry 2 \
            --retry-delay 5 \
            "${{ secrets.SITE_URL }}/api/health" 2>/dev/null || echo "000")

          echo "HTTP Status: $HTTP_STATUS"
          echo "status=$HTTP_STATUS" >> $GITHUB_OUTPUT

          if [ "$HTTP_STATUS" = "200" ]; then
            echo "âœ… Site is UP and healthy"
            cat response.txt || true
          elif [ "$HTTP_STATUS" = "000" ]; then
            echo "ğŸ”´ SITE UNREACHABLE â€” no response from server"
            exit 1
          else
            echo "ğŸŸ¡ Site returned unexpected status: $HTTP_STATUS"
            cat response.txt || true
            exit 1
          fi

      - name: Send Telegram alert on failure
        if: failure()
        run: |
          TIMESTAMP=$(date -u '+%Y-%m-%d %H:%M UTC')
          STATUS="${{ steps.ping.outputs.status }}"

          MSG="ğŸ”´ SITE DOWN â€” NSS Portal%0A"
          MSG="${MSG}â° Time: ${TIMESTAMP}%0A"
          MSG="${MSG}ğŸŒ URL: ${{ secrets.SITE_URL }}%0A"
          MSG="${MSG}ğŸ“Š Status: ${STATUS:-unreachable}%0A"
          MSG="${MSG}%0AChecked by GitHub Actions â€” investigate immediately!"

          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -d "chat_id=${{ secrets.TELEGRAM_CHAT_ID }}" \
            -d "text=${MSG}"

          echo "ğŸ“± Telegram alert sent"
